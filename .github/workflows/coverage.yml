name: coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-18 llvm-18 ninja-build jq

      - name: Configure
        run: cmake --preset cov-clang

      - name: Build
        run: cmake --build --preset cov-clang -j"$(nproc)"

      - name: Test
        run: |
          rm -rf build/cov-clang/coverage
          mkdir -p build/cov-clang/coverage
          ctest --preset cov-clang --output-on-failure

      - name: Merge profiles
        run: |
          llvm-profdata-18 merge -sparse build/cov-clang/coverage/*.profraw \
            -o build/cov-clang/coverage/coverage.profdata

      - name: Export lcov
        run: |
          ctest --preset cov-clang --show-only=json-v1 > build/cov-clang/ctest.json
          mapfile -t ALL < <(jq -r '.tests[].command[0]' build/cov-clang/ctest.json | sort -u)
          BINS=()
          for b in "${ALL[@]}"; do
            [[ -x "$b" && "$b" == "$(pwd)/build/cov-clang/"* ]] && BINS+=("$b")
          done
          (( ${#BINS[@]} > 0 )) || { echo "No test executables found"; exit 1; }
          OBJ_ARGS=()
          for o in "${BINS[@]}"; do OBJ_ARGS+=(-object "$o"); done
          llvm-cov-18 export \
            -format=lcov \
            -instr-profile=build/cov-clang/coverage/coverage.profdata \
            "${OBJ_ARGS[@]}" \
            -sources "$(pwd)/include" \
            > build/cov-clang/coverage/coverage.lcov

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/cov-clang/coverage/coverage.lcov
          fail_ci_if_error: true
          verbose: true
