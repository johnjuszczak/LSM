name: coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14 lcov ninja-build

      - name: Configure
        run: cmake --preset cov-gcc

      - name: Build
        run: cmake --build --preset cov-gcc -j"$(nproc)"

      - name: Test
        run: |
          rm -rf build/cov-gcc/coverage
          mkdir -p build/cov-gcc/coverage
          ctest --preset cov-gcc --output-on-failure

      - name: Capture LCOV
        run: |
          geninfo build/cov-gcc \
            --gcov-tool gcov-14 \
            --output-filename build/cov-gcc/coverage/coverage.raw.lcov \
            --base-directory "${{ github.workspace }}" \
            --no-external
          lcov --gcov-tool gcov-14 \
            --extract build/cov-gcc/coverage/coverage.raw.lcov "${{ github.workspace }}/include/*" \
            -o build/cov-gcc/coverage/coverage.lcov
          rm -f build/cov-gcc/coverage/coverage.raw.lcov

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: build/cov-gcc/coverage/coverage.lcov
          disable_search: true
          fail_ci_if_error: true
          verbose: true
